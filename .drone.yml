workspace:
    base: /rust

pipeline:
    # unit:
    #     environment:
    #         - CARGO_HOME=/var/cache/drone/cargo
    #         - RUST_BACKTRACE=1
    #     image: "rustlang/rust:nightly"
    #     commands:
    #         - rustc --version && cargo --version  # Print version info for debugging
    #         - chmod +x scripts/test-setup.sh
    #         - ./scripts/test-setup.sh
    #         - cargo test --jobs 1            # Run serial for more readable errors
    regression:
        environment:
            - CARGO_HOME=/var/cache/drone/cargo
            - RUST_BACKTRACE=1
        image: "rustlang/rust:nightly"
        commands:
            - echo ${APP_AUTH}
            - export FILENAME=`date +%s`_quick.json
            - export RUST_LOG=info 
            - rustc --version && cargo --version  # Print version info for debugging
            - cargo build --release
            - target/release/braid regression -o $FILENAME resources/regression/configs/quick.yaml
            - curl -u ${APP_AUTH} -F "file=@$FILENAME;type=text/json" http://bax.pythonanywhere.com/upload
        secrets: [ app_auth ]
